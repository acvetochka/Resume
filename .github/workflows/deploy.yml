name: Build and deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–¥
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
      - name: Install dependencies üîß
        run: npm ci

      # 3Ô∏è‚É£ –ë—ñ–ª–¥ –¥–ª—è GitHub Pages
      - name: Build for GitHub Pages üåê
        run: npm run build -- --public-url /Resume/

      # 4Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ gh-pages
      - name: Deploy to GH Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist

      # 5Ô∏è‚É£ –û—á–∏—â–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –±—ñ–ª–¥–æ–º –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
      - name: Clean dist before server build
        run: rm -rf dist

      # 6Ô∏è‚É£ –ë—ñ–ª–¥ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ DigitalOcean
      - name: Build for Server üñ•Ô∏è
        run: npm run build -- --public-url ./

      # 7Ô∏è‚É£ –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ SSH
      - name: Set up SSH keys for server deployment
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # 8Ô∏è‚É£ –ö–æ–ø—ñ—é—î–º–æ –∑—ñ–±—Ä–∞–Ω—ñ —Ñ–∞–π–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Upload build to server üì¶
        run: |
          rsync -avz --delete dist/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:{{ secrets.DEPLOY_PATH }}

      # 9Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
      - name: Restart app on server üîÅ
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP } << 'EOF'
            cd ${{ secrets.PROJECT_PATH }}
            pm2 restart ${{ secrets.PM_PROCESS }} || echo "PM2 process not found, skipping restart"
          EOF
